using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;

using FreeLayout.App_Code;
using System.Web.Script.Serialization;
using System.Web.Services;
using System.Net;
using System.Data;
using System.Data.SqlClient;
using System.Data.OleDb;
using System.IO;

namespace FreeLayout.QCC
{
    public partial class UploadReability : System.Web.UI.Page
    {

        DataConn cnn = new DataConn();
        public DataTable dt = new DataTable();
        public DataTable dt1 = new DataTable();
        protected void Page_Load(object sender, EventArgs e)
        {
            if (!IsPostBack)
            {
                BindGroupList();                
            }
            dt = DataConn.StoreFillDS("Get_mater_reliablity", System.Data.CommandType.StoredProcedure);

        }

        [WebMethod]
        protected void BindGroupList()
        {
            DataTable dt2 = new DataTable();
            dt2 = DataConn.StoreFillDS("pro_typecheck_select", CommandType.StoredProcedure);
            Drop_typecheck.DataSource = dt2;
            Drop_typecheck.DataBind();
        }

        public void BtndeleteItem(object sender, EventArgs e)
        {
            string _id = txtid.Text.ToString();
            string userid = txtuserid.Text.ToString();

            DataTable dt5 = new DataTable();
            DataTable dtuser = new DataTable();
            if (userid == "")
            {
                Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG, user does not input infor!'); ", true);
            }
            else
            {
                //check user co trong bang user khong?
                dtuser = DataConn.StoreFillDS("Pro_CheckUser_QC", System.Data.CommandType.StoredProcedure, userid);
                if (dtuser.Rows[0][0].ToString() == "1")
                {
                    ////user eixsts mater
                    dt5 = DataConn.StoreFillDS("Pro_Remove_Item_mater", System.Data.CommandType.StoredProcedure, _id, userid);
                    if (dt5.Rows[0][0].ToString() == "1")
                    {
                        Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.success('Success!!!');", true);
                        dt = DataConn.StoreFillDS("Get_mater_reliablity", System.Data.CommandType.StoredProcedure);
                        txtuserid.Text = "";
                    }
                    else
                    {
                        Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG, You do not permission!'); ", true);
                        txtuserid.Text = "";
                    }
                }
                else
                {
                    //user not eixsts
                    Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG, user does not exists!'); ", true);
                    txtuserid.Text = "";
                }
            }


        }

        protected void SaveClick(object sender, EventArgs e)
        {
            DataTable dt1 = new DataTable();
            string _id = idcheck.Text;
            string _material = material.Text;
            string _cate = cate.Text;
            string _vendor = vendor.Text;
            string _typecheck = Drop_typecheck.Text;

            string weightofJIG = txtweightofjig.Text;
            string totalCycles = txttotalcycles.Text;
            string samplePosition = txtsampleposition.Text;
            string path_wi = txtpath.Text;

            dt1 = DataConn.StoreFillDS("update_mater_Reliability", System.Data.CommandType.StoredProcedure, _id, _material, _cate, _vendor, _typecheck, weightofJIG, totalCycles, samplePosition, path_wi);
            if (dt1.Rows[0][0].ToString() == "1")
            {
                Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.success('Successful!');", true);
                dt = DataConn.StoreFillDS("Get_mater_reliablity", System.Data.CommandType.StoredProcedure);
            }
            else
            {
                Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG, check again!'); ", true);
            }

        }

        [WebMethod]
        public static string getfulpath2(string material)
        {
            String path = "";
            DataTable dt = new DataTable();
            dt = DataConn.StoreFillDS("Get_path_WI_document", System.Data.CommandType.StoredProcedure, material);
            //if (dt.Rows.Count > 0)
            if (dt.Rows[0][0].ToString() == "1")
            {
                path = dt.Rows[0][1].ToString();
            }
            //truong hop khong co 
            else
            {
                path = "";
            }

            return path;
        }

        protected void btnDownloadClick(Object sender, EventArgs e)
        {
            try
            {
                string fileName = "mauupload_reliability.xlsx";
                string fileExtension = ".xlsx";

                // Set Response.ContentType
                Response.ContentType = GetContentType(fileExtension);

                // Append header
                Response.AppendHeader("Content-Disposition", "attachment; filename=" + fileName);

                // Write the file to the Response
                Response.TransmitFile(Server.MapPath("~/Textfile/" + fileName));
                Response.End();
            }
            catch (Exception)
            {
                throw;
            }
        }


        private string GetContentType(string fileExtension)
        {
            if (string.IsNullOrEmpty(fileExtension))
                return string.Empty;

            string contentType = string.Empty;
            switch (fileExtension)
            {
                case ".htm":
                case ".html":
                    contentType = "text/HTML";
                    break;
                case ".csv":
                case ".txt":
                    contentType = "text/plain";
                    break;

                case ".doc":
                case ".rtf":
                case ".docx":
                    contentType = "Application/msword";
                    break;

                case ".xls":
                case ".xlsx":
                    contentType = "Application/x-msexcel";
                    break;

                case ".jpg":
                case ".jpeg":
                    contentType = "image/jpeg";
                    break;

                case ".gif":
                    contentType = "image/GIF";
                    break;

                case ".pdf":
                    contentType = "application/pdf";
                    break;
            }
            return contentType;
        }

        protected void ImportFromExcel(object sender, EventArgs e)
        {
            // CHECK IF A FILE HAS BEEN SELECTED.
            if ((FileUpload.HasFile))
            {

                if (!Convert.IsDBNull(FileUpload.PostedFile) &
                    FileUpload.PostedFile.ContentLength > 0)
                {
                    DataConn.Execute_NonSQL("truncate table [FREE_LOCATION].[dbo].[DM_Mater_Reability];");

                    //FIRST, SAVE THE SELECTED FILE IN THE ROOT DIRECTORY.
                    FileUpload.SaveAs(Server.MapPath(".") + "\\" + FileUpload.FileName);

                    SqlBulkCopy oSqlBulk = null;

                    // SET A CONNECTION WITH THE EXCEL FILE.
                    OleDbConnection myExcelConn = new OleDbConnection
                        ("Provider=Microsoft.ACE.OLEDB.12.0; " +
                            "Data Source=" + Server.MapPath(".") + "\\" + FileUpload.FileName +
                            ";Extended Properties=Excel 12.0;");
                    try
                    {
                        myExcelConn.Open();

                        // GET DATA FROM EXCEL SHEET.
                        OleDbCommand objOleDB =
                            new OleDbCommand("SELECT *FROM [Sheet1$]", myExcelConn);

                        // READ THE DATA EXTRACTED FROM THE EXCEL FILE.
                        OleDbDataReader objBulkReader = null;
                        objBulkReader = objOleDB.ExecuteReader();

                        // SET THE CONNECTION STRING.
                        string sCon = "Data Source=10.92.186.30;Persist Security Info=False;" +
                            "Initial Catalog=FREE_LOCATION;User Id=sa;Password=Psnvdb2013;" +
                            "Connect Timeout=30;";

                        using (SqlConnection con = new SqlConnection(sCon))
                        {
                            con.Open();                            
                            // FINALLY, LOAD DATA INTO THE DATABASE TABLE.
                            oSqlBulk = new SqlBulkCopy(con);
                            oSqlBulk.DestinationTableName = "DM_Mater_Reability"; // TABLE NAME.
                            oSqlBulk.WriteToServer(objBulkReader);
                        }

                        lblConfirm.Text = "DATA IMPORTED SUCCESSFULLY.";
                        lblConfirm.Attributes.Add("style", "color:green");
                        Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.success('Thành công!');", true);

                        //File.Delete(Server.MapPath(".") + "\\" + FileUpload.FileName); // DELETE THE FILE upload len.

                        //load grid
                        dt = DataConn.StoreFillDS("Get_mater_reliablity", System.Data.CommandType.StoredProcedure);
                        //LoadData();
                    }
                    catch (Exception ex)
                    {

                        lblConfirm.Text = ex.Message;
                        lblConfirm.Attributes.Add("style", "color:red");

                    }
                    finally
                    {
                        // CLEAR.
                        oSqlBulk.Close();
                        oSqlBulk = null;
                        myExcelConn.Close();
                        myExcelConn = null;
                    }
                }
            }
        }



    }
}