using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;

using FreeLayout.App_Code;
using System.Web.Services;
using System.IO;
using System.Net;
using System.Data;
using System.Diagnostics;

namespace FreeLayout.QCC
{
    public partial class RoshInspection : System.Web.UI.Page
    {
        DataConn cnn = new DataConn();
        public DataTable dt = new DataTable();
        public DataTable dtfilter = new DataTable();
        public DataTable dtcate = new DataTable();

        protected void Page_Load(object sender, EventArgs e)
        {
            if (!IsPostBack)
            {
               
                dtcate = DataConn.StoreFillDS("Get_filter_cate2", System.Data.CommandType.StoredProcedure);
                DataRow newRow2 = dtcate.NewRow();
                newRow2["NameFilter"] = "==select==";
                dtcate.Rows.InsertAt(newRow2, 0);
                dr_filter_cate.DataSource = dtcate;
                dr_filter_cate.DataBind();
            }
            string _cate = Request.QueryString["cate"];
            DataTable dtfiltercate = new DataTable();

            if (_cate != null)
            {
                dtfiltercate = DataConn.StoreFillDS("Get_mater_list_QC_filtercate_rosh", System.Data.CommandType.StoredProcedure, _cate);
                if (dtfiltercate.Rows.Count > 0)
                {
                    dt = DataConn.StoreFillDS("Get_mater_list_QC_filtercate_rosh", System.Data.CommandType.StoredProcedure, _cate);
                    dr_filter_cate.Text = Request.QueryString["cate"];
                }
                else
                {
                    Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.warning('Check again mater!','Error'); ", true);
                    dr_filter_cate.Text = Request.QueryString["cate"];
                }

            }
            else
            {
                dt = DataConn.StoreFillDS("Get_mater_list_QC_Rosh", System.Data.CommandType.StoredProcedure);
            }
            //dt = DataConn.StoreFillDS("Get_mater_list_QC_Rosh", System.Data.CommandType.StoredProcedure);
        }

        [WebMethod]
        public static string getQTYNG(string _id)
        {
            String thongbao = "";
            DataTable dt4 = new DataTable();
            dt4 = DataConn.StoreFillDS("Pro_getQTYNG", System.Data.CommandType.StoredProcedure, _id);

            if (dt4.Rows[0][0].ToString() == "1")
            {
                thongbao = "OK" + "," + dt4.Rows[0][1].ToString() + "," + dt4.Rows[0][2].ToString();
            }
            else
            {
                thongbao = "NG";
            }

            return thongbao;
        }


        [WebMethod]
        public static string GetNormalCheck(string material)
        {
            String thongbao = "";
            DataTable dt3 = new DataTable();
            dt3 = DataConn.StoreFillDS("Pro_getmater_normalcheck", System.Data.CommandType.StoredProcedure, material);
            if (dt3.Rows[0][0].ToString() == "1")
            {
                thongbao = dt3.Rows[0][0].ToString() + "," + dt3.Rows[0][1].ToString(); //"Check Reliability Testing !";
            }
            else if (dt3.Rows[0][0].ToString() == "2")
            {
                thongbao = dt3.Rows[0][0].ToString() + "," + dt3.Rows[0][1].ToString(); ;// "Have WI document!";
            }
            else
            {
                //hang check binh thuong khong co mater.
                thongbao = "Not document!";
            }
            return thongbao;
        }

        protected void BtnFinishRosh(object sender, EventArgs e)
        {
            DataTable dt2 = new DataTable();
            DataTable dtuser = new DataTable();

            string _id = ID2.Text.ToString();
            string _material = Material2.Text.ToString();
            string qty_NG = _QTYNG.Text.ToString();
            string loi_NG = namemistake.Text.ToString();

            string userid = txtuserfinished.Text.ToString();

            string kq = "";
            if (RadioButton1.Checked == true)
            {
                kq = "OK";
            }
            if (RadioButton2.Checked == true)
            {
                kq = "NG";
            }
            //object[] obj = new object[] { _id, _material, kq };
            if (qty_NG == "0")
            {
                Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('Qty must greater 0!!!'); ", true);
            }
            else
            {
                //kiem tra user ***
                if (userid == "")
                {
                    Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG, user does not input infor!'); ", true);
                }
                else
                {
                    //check user co trong bang user khong?
                    dtuser = DataConn.StoreFillDS("Pro_CheckUser_QC", System.Data.CommandType.StoredProcedure, userid);
                    if (dtuser.Rows[0][0].ToString() == "1")
                    {
                        // save finished -> R3
                        dt2 = DataConn.StoreFillDS("Pro_Finish_Check_QC_rosh", System.Data.CommandType.StoredProcedure, _id, _material, kq, qty_NG, loi_NG, userid);
                        if (dt2.Rows[0][0].ToString() == "1")
                        {
                            Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.success('Successful!!!');", true);
                            dt = DataConn.StoreFillDS("Get_mater_list_QC_Rosh", System.Data.CommandType.StoredProcedure);
                            txtuserfinished.Text = "";
                        }
                        else if (dt2.Rows[0][0].ToString() == "2")
                        {
                            //truong hop nay xac nhan voi QC*** ==> edit them phan hien thi so luong NG tren form ==> fix ok
                            Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.success('Edit QTY NG Successful!!!');", true);
                            dt = DataConn.StoreFillDS("Get_mater_list_QC_Rosh", System.Data.CommandType.StoredProcedure);
                            txtuserfinished.Text = "";
                        }
                        else
                        {
                            Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG!!!'); ", true);
                            txtuserfinished.Text = "";
                        }
                    }
                    else
                    {
                        Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG, user does not exists!'); ", true);
                        txtuserfinished.Text = "";
                    }
                }
            }
        }

        public void BtnRemoveItemRosh(object sender, EventArgs e)
        {
            string _id = ID4.Text.ToString();
            string userid = txtuseridxoa.Text.ToString();
            DataTable dt5 = new DataTable();
            DataTable dtuser = new DataTable();

            if (userid == "")
            {
                Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG, user does not input infor!'); ", true);
            }
            else
            {
                //check user co trong bang user khong?
                dtuser = DataConn.StoreFillDS("Pro_CheckUser_QC", System.Data.CommandType.StoredProcedure, userid);
                if (dtuser.Rows[0][0].ToString() == "1")
                {
                    ////user eixsts mater
                    dt5 = DataConn.StoreFillDS("Pro_Remove_Item", System.Data.CommandType.StoredProcedure, _id, userid);
                    if (dt5.Rows[0][0].ToString() == "1")
                    {
                        Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.success('Success!!!');", true);
                        dt = DataConn.StoreFillDS("Get_mater_list_QC_Rosh", System.Data.CommandType.StoredProcedure);
                        txtuseridxoa.Text = "";
                    }
                    else
                    {
                        Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG, Item haved deleted! (not check)'); ", true);
                        txtuseridxoa.Text = "";
                    }
                }
                else
                {
                    //user not eixsts
                    Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG, user does not exists!'); ", true);
                    txtuseridxoa.Text = "";
                }
            }
        }

        protected void BtnAddClickRosh(object sender, EventArgs e)
        {
            DataTable dt1 = new DataTable();
            DataTable dtuser = new DataTable();

            string _id = idcheck.Text.ToString();
            string _location = location.Text.ToString();
            string _qty = Qtysmaple.Text.ToString();
            string _qtytest = Qtytest.Text.ToString();
            string _invoice = Invoice.Text.ToString();

            string _material = material.Text.ToString();

            string _cate = dr_filter_cate.Text;
            //string typecheck = dr_TypeChek.Text;            
            //object[] obj = new object[] { _id, material.Text, _location, _qty, _invoice };

            string userid = txtusercheck.Text.ToString();

            if (userid == "")
            {
                //****
                Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG, user does not input infor!'); ", true);
            }
            else
            {
                //check user co trong bang user khong?
                dtuser = DataConn.StoreFillDS("Pro_CheckUser_QC", System.Data.CommandType.StoredProcedure, userid);
                if (dtuser.Rows[0][0].ToString() == "1")
                {
                    //check xem ma do co phai hang WI document hay khong?
                    DataTable dt2 = new DataTable();
                    dt2 = DataConn.StoreFillDS("Get_path_WI_document", System.Data.CommandType.StoredProcedure, _material);
                    if (dt2.Rows[0][0].ToString() == "1")
                    {
                        dt1 = DataConn.StoreFillDS("check_status_update_QC", System.Data.CommandType.StoredProcedure, _id, _location, _qty, _invoice, _qtytest, userid);
                        if (dt1.Rows[0][0].ToString() == "1")
                        {
                            Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.success('Success!!!');", true);
                            if (_cate != "==select==")
                            {
                                dt = DataConn.StoreFillDS("Get_mater_list_QC_filtercate_rosh", System.Data.CommandType.StoredProcedure, _cate);
                                dr_filter_cate.Text = Request.QueryString["cate"];
                                txtusercheck.Text = "";
                            }
                            else
                            {
                                dt = DataConn.StoreFillDS("Get_mater_list_QC_Rosh", System.Data.CommandType.StoredProcedure);
                                txtusercheck.Text = "";
                            }
                            
                        }
                        else
                        {
                            Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG!!!'); ", true);
                            txtusercheck.Text = "";
                        }
                    }
                    else
                    {
                        //hang issue out sang SAP -> bat buoc phai nhap QTY test
                        if (_qtytest == "" || _qtytest == "0")
                        {
                            Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('Fail, You must to input QTY test!!!'); ", true);
                        }
                        else
                        {
                            dt1 = DataConn.StoreFillDS("check_status_update_QC", System.Data.CommandType.StoredProcedure, _id, _location, _qty, _invoice, _qtytest, userid);
                            if (dt1.Rows[0][0].ToString() == "1")
                            {
                                Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.success('Success!!!');", true);
                                if (_cate != "==select==")
                                {
                                    dt = DataConn.StoreFillDS("Get_mater_list_QC_filtercate_rosh", System.Data.CommandType.StoredProcedure, _cate);
                                    dr_filter_cate.Text = Request.QueryString["cate"];
                                    txtusercheck.Text = "";
                                }
                                else
                                {
                                    dt = DataConn.StoreFillDS("Get_mater_list_QC_Rosh", System.Data.CommandType.StoredProcedure);
                                    txtusercheck.Text = "";
                                }                                
                            }
                            else
                            {
                                Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG!!!'); ", true);
                                txtusercheck.Text = "";
                            }
                        }
                    }
                }
                else
                {
                    //khong ton tai user mater
                    Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG, user does not exists!'); ", true);
                    txtusercheck.Text = "";
                }

            }
        }




    }
}