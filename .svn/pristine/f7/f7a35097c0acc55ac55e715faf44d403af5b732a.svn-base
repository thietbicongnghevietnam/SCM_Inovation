using System;
using System.Web.UI;

using FreeLayout.App_Code;
using System.Web.Services;
using System.IO;
using System.Net;
using System.Data;
using System.Diagnostics;

namespace FreeLayout.QCC
{
    public partial class Normalinspection : System.Web.UI.Page
    {

        DataConn cnn = new DataConn();
        public DataTable dt = new DataTable();
        string exportTo = "";
        public static string[] lst_keep_refresh;

        protected void Page_Load(object sender, EventArgs e)
        {

            //exportTo = File.ReadAllText(Server.MapPath("~/TextFile/kitting_droplist.txt"));
            if (!IsPostBack)
            {
                //doan nay khong can vi type check display theo mater
                //List<string> lst = exportTo.Split(',').ToList();
                //dr_TypeChek.DataSource = lst;
                //dr_TypeChek.DataBind();
            }
            dt = DataConn.StoreFillDS("Get_mater_list_QC", System.Data.CommandType.StoredProcedure);

        }

        protected void Search_Date_Click(object sender, EventArgs e)
        {
            string _date = Request.Form[datepicker.UniqueID];
            //09-08-2021
            if (_date == "")
            {
                dt = DataConn.StoreFillDS("Get_mater_list_QC", System.Data.CommandType.StoredProcedure);
            }
            else
            {
                string nam = _date.Substring(6, 4);
                string thang = _date.Substring(3, 2);
                string ngay = _date.Substring(0, 2);
                string _date2 = nam + "-" + thang + "-" + ngay;

                dt = DataConn.StoreFillDS("Get_mater_list_QC_date", System.Data.CommandType.StoredProcedure, _date2);
            }
        }
    
        protected void openfile_Click(object sender, EventArgs e)
        {
            DataTable dt_path = new DataTable();
            string filePath = "";
            //string filePath = "G:\\IT\\12.Personal\\letter_sakurai.pdf";  ==> hien tai chi mo duoc file .pdf
            //string filePath = "G:\\IT\\12.Personal\\zqv031.XLS";
            string _mateial = material.Text.ToString();
            dt_path = DataConn.StoreFillDS("Get_path_WI_document", System.Data.CommandType.StoredProcedure, _mateial);

            if (dt_path.Rows[0][0].ToString() == "1")
            {
                //string filePath = @"G:\IT\02.Request Form\01.Account Authorization(Infrastructure team).xlsx";
                filePath = dt_path.Rows[0][1].ToString();
                var path = Server.MapPath("~/TextFile/path.txt");
                System.IO.File.WriteAllText(path, filePath);
                Process process = new Process();
                process.StartInfo.FileName = @"C:\ReadPathQC\WindowsFormsApplication1.exe";
                process.StartInfo.Arguments = "if any";
                process.Start();
                process.WaitForExit();
                process.Close();
            }
            else
            {
                Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG, check information!!!'); ", true);
            }
            
            //string filePath = "E:\\He thong\\Minh 2020\\Thang 8.2021\\mau upload WI.xlsx";
            //string fileExtention = Path.GetExtension(filePath);
            //WebClient client = new WebClient();
            //Byte[] buffer = client.DownloadData(filePath);
            //Response.ContentType = ReturnExtension(fileExtention);
            //if (Response.ContentType == "application/pdf")
            //{
            //    Response.AddHeader("content-length", buffer.Length.ToString());
            //    Response.BinaryWrite(buffer);
            //}
            //else
            //{
            //    Response.AddHeader("content-length", buffer.Length.ToString());
            //    Response.AppendHeader("Content-Disposition", "inline;filename=" + filePath);  //dowload  ==> xu ly nut bang javascritp
            //    Response.BinaryWrite(buffer);

            //}
        }

        //protected void bttnpdf_Click(object sender, EventArgs e)
        //{
        //    string _path = test.InnerHtml;
        //    //string FilePath = Server.MapPath("~/TextFile/letter_sakurai.pdf");
        //    string FilePath = Server.MapPath(_path);
        //    //Response.ContentType = "application/pdf";
        //    //Response.WriteFile(FilePath);
        //    WebClient User = new WebClient();
        //    Byte[] FileBuffer = User.DownloadData(FilePath);
        //    if (FileBuffer != null)
        //    {
        //        Response.ContentType = "application/pdf";
        //        Response.AddHeader("content-length", FileBuffer.Length.ToString());
        //        Response.BinaryWrite(FileBuffer);
        //    }
        //}

        private string ReturnExtension(string fileExtension)
        {
            switch (fileExtension)
            {
                case ".htm":
                case ".html":
                case ".log":
                    return "text/HTML";
                case ".txt":
                    return "text/plain";
                case ".doc":
                    return "application/ms-word";
                case ".tiff":
                case ".tif":
                    return "image/tiff";
                case ".asf":
                    return "video/x-ms-asf";
                case ".avi":
                    return "video/avi";
                case ".zip":
                    return "application/zip";
                case ".xls":
                case ".XLS":
                    return "application/vnd.ms-excel";
                case ".csv":
                    return "application/vnd.ms-excel";
                case ".xlsx":                
                    return "application/vnd.ms-excel";
                case ".gif":
                    return "image/gif";
                case ".jpg":
                case "jpeg":
                    return "image/jpeg";
                case ".bmp":
                    return "image/bmp";
                case ".wav":
                    return "audio/wav";
                case ".mp3":
                    return "audio/mpeg3";
                case ".mpg":
                case "mpeg":
                    return "video/mpeg";
                case ".rtf":
                    return "application/rtf";
                case ".asp":
                    return "text/asp";
                case ".pdf":
                    return "application/pdf";
                case ".fdf":
                    return "application/vnd.fdf";
                case ".ppt":
                case ".pptx":
                    return "application/mspowerpoint";
                case ".dwg":
                    return "image/vnd.dwg";
                case ".msg":
                    return "application/msoutlook";
                case ".xml":
                case ".sdxl":
                    return "application/xml";
                case ".xdp":
                    return "application/vnd.adobe.xdp+xml";
                default:
                    return "application/octet-stream";
            }
        }

        [WebMethod]
        public static string getdocumentWI(string material)
        {
            String path = "";
            DataTable dt = new DataTable();
            dt = DataConn.StoreFillDS("Pro_getdocumentWI", System.Data.CommandType.StoredProcedure, material);
            //if (dt.Rows.Count > 0)
            if (dt.Rows[0][0].ToString() == "0")
            {
                path = "Chua co document WI!";
            }
            //truong hop khong co 
            else
            {
                path = dt.Rows[0][0].ToString();
            }

            return path;
        }

        [WebMethod]
        protected void BtnFinish(object sender, EventArgs e)
        {
            DataTable dt2 = new DataTable();
            string _id = ID2.Text.ToString();
            string _material = Material2.Text.ToString();
            string kq = "";
            if (RadioButton1.Checked == true)
            {
                kq = "OK";
            }
            if (RadioButton2.Checked == true)
            {
                kq = "NG";
            }
            object[] obj = new object[] { _id, _material, kq };
            dt2 = DataConn.StoreFillDS("Pro_Finish_Check_QC", System.Data.CommandType.StoredProcedure, _id, _material, kq);

            if (dt2.Rows[0][0].ToString() == "1")
            {
                Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.success('Thành công!');", true);
                dt = DataConn.StoreFillDS("Get_mater_list_QC", System.Data.CommandType.StoredProcedure);
            }
            else
            {
                Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG!!!'); ", true);
            }
        }

        [WebMethod]
        public static string GetNormalCheck(string material)
        {
            String thongbao = "";
            DataTable dt = new DataTable();
            dt = DataConn.StoreFillDS("Pro_getmater_normalcheck", System.Data.CommandType.StoredProcedure, material);
            if (dt.Rows[0][0].ToString() == "1")
            {
                thongbao = dt.Rows[0][0].ToString()+","+dt.Rows[0][1].ToString(); //"Check Reliability Testing !";
            }
            else if (dt.Rows[0][0].ToString() == "2")
            {
                thongbao = dt.Rows[0][0].ToString() + "," + dt.Rows[0][1].ToString(); ;// "Have WI document!";
            }
            else
            {
                //hang check binh thuong khong co mater.
                thongbao = "Not document!";
            }
            return thongbao;
        }

        [WebMethod]
        protected void BtnAddClick(object sender, EventArgs e)
        {
            DataTable dt1 = new DataTable();
            string _id = idcheck.Text;
            string _location = location.Text;
            string _qty = Qty.Text;
            string _invoice = Invoice.Text;
            //string typecheck = dr_TypeChek.Text;
            //string userid = "";
            object[] obj = new object[] { _id, material.Text, _location, _qty, _invoice };

            dt1 = DataConn.StoreFillDS("check_status_update_QC", System.Data.CommandType.StoredProcedure, _id, _location, _qty, _invoice);
            //int status = DataConn.ExecuteStoreInt("pro_user_add", CommandType.StoredProcedure, obj);
            if (dt1.Rows[0][0].ToString() == "1")
            {
                Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.success('Thành công!');", true);
                dt = DataConn.StoreFillDS("Get_mater_list_QC", System.Data.CommandType.StoredProcedure);
            }
            else
            {
                Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.error('NG!!!'); ", true);
            }

            //if (typecheck == "==Select==")
            //{
            //    Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "toastr.warning('Bạn phải chọn các bước check!'); ", true);
            //    //Page.ClientScript.RegisterStartupScript(Page.GetType(), "Message", "alert('Ban phai chon loai check');", true);
            //    //"alert('FiveDot File uploaded successfully');
            //    dt = DataConn.StoreFillDS("Get_mater_list_QC", System.Data.CommandType.StoredProcedure);
            //}
            //else
            //{

            //}

        }

    }
}